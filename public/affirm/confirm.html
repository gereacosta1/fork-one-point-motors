<!doctype html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Pago con Affirm – Confirmado</title>
    <style>
      body { background:#0b0b0b; color:#fff; font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,"Helvetica Neue",Arial,"Noto Sans"; margin:0; padding:40px; }
      .card { max-width:720px; margin:0 auto; background:#111; border:1px solid #2a2a2a; border-radius:16px; padding:24px; }
      .ok { display:inline-block; padding:6px 10px; border-radius:999px; background:#16a34a; color:#fff; font-weight:700; font-size:12px; letter-spacing:.02em; }
      a { color:#38bdf8; }
      .muted { color:#cfcfcf; }
      .hint { margin-top:14px; font-size:13px; color:#9aa0a6; }
      pre { background:#0f0f0f; border:1px solid #272727; border-radius:12px; padding:12px; overflow:auto; color:#e5e7eb; }
      .error { color:#f87171; }
      .success { color:#34d399; }
      .warn { color:#fbbf24; }
    </style>
  </head>
  <body>
    <div class="card">
      <div class="ok">Confirmado</div>
      <h1>Gracias, tu solicitud en Affirm fue enviada.</h1>
      <p class="muted">
        Ya podés cerrar esta ventana y volver a la tienda. Si no ves el pedido reflejado, avisale al vendedor.
      </p>
      <p><a href="/">Volver a ONE POINT MOTORS</a></p>

      <div id="status" class="hint">Procesando confirmación…</div>
      <pre id="debug" style="display:none"></pre>

      <script>
        (async () => {
          const statusEl = document.getElementById("status");
          const debugEl = document.getElementById("debug");

          const showDebug = (obj) => {
            debugEl.style.display = "block";
            debugEl.textContent = JSON.stringify(obj, null, 2);
          };

          const q = new URLSearchParams(location.search);

          // 1) Token (preferimos querystring, pero soportamos storage también)
          const tokenFromQuery = q.get("checkout_token");
          const tokenFromSession = (() => { try { return sessionStorage.getItem("affirm_checkout_token"); } catch { return null; }})();
          const tokenFromLocal = (() => { try { return localStorage.getItem("affirm_checkout_token"); } catch { return null; }})();

          const checkout_token = tokenFromQuery || tokenFromSession || tokenFromLocal;

          // 2) Datos del pedido (estos DEBEN haberse seteado ANTES de abrir Affirm)
          const order_id = (() => { try { return sessionStorage.getItem("affirm_order_id") || localStorage.getItem("affirm_order_id"); } catch { return null; }})();
          const amount_cents_raw = (() => { try { return sessionStorage.getItem("affirm_order_amount_cents") || localStorage.getItem("affirm_order_amount_cents"); } catch { return null; }})();
          const amount_cents = Number(amount_cents_raw);

          const captured_order_id = (() => { try { return sessionStorage.getItem("affirm_captured_order_id") || localStorage.getItem("affirm_captured_order_id"); } catch { return null; }})();

          // A) Si no hay token, no hay nada que autorizar/capturar
          // Esto suele pasar si tu user_confirmation_url_action es POST y estás en un HTML estático:
          // el browser navega, pero JS no puede leer el body del POST.
          if (!checkout_token) {
            statusEl.innerHTML = '<span class="warn">Confirmación recibida, pero no se detectó checkout_token.</span>';
            showDebug({
              ok: false,
              step: "confirm.html",
              error: "missing_checkout_token",
              hint: "Asegurate de enviar checkout_token por GET (user_confirmation_url_action='GET') o guardarlo en storage via onSuccess.",
              tokenFromQuery: Boolean(tokenFromQuery),
              tokenFromSession: Boolean(tokenFromSession),
              tokenFromLocal: Boolean(tokenFromLocal),
            });
            return;
          }

          // B) Si ya capturaste en onSuccess, evitamos doble capture
          if (captured_order_id && order_id && captured_order_id === order_id) {
            statusEl.innerHTML = '<span class="success">Confirmación completada (ya capturado en onSuccess).</span>';
            try {
              sessionStorage.removeItem("affirm_order_id");
              sessionStorage.removeItem("affirm_order_amount_cents");
              sessionStorage.removeItem("affirm_checkout_token");
              sessionStorage.removeItem("affirm_captured_order_id");
              localStorage.removeItem("affirm_order_id");
              localStorage.removeItem("affirm_order_amount_cents");
              localStorage.removeItem("affirm_checkout_token");
              localStorage.removeItem("affirm_captured_order_id");
            } catch {}
            return;
          }

          // C) Validación de datos locales del pedido
          if (!order_id || !Number.isFinite(amount_cents) || amount_cents <= 0) {
            statusEl.innerHTML = '<span class="error">Confirmado, pero faltó información local para cerrar el pago.</span>';
            showDebug({
              ok: false,
              step: "confirm.html",
              error: "missing_order_id_or_amount",
              has_order_id: Boolean(order_id),
              amount_cents_raw,
              checkout_token_present: true,
            });
            return;
          }

          // D) Autorizar + Capturar en tu backend (Netlify Function)
          try {
            const r = await fetch("/.netlify/functions/affirm-authorize", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ checkout_token, order_id, amount_cents, capture: true }),
            });

            const data = await r.json().catch(() => ({}));

            if (!r.ok || !data.ok) {
              statusEl.innerHTML = '<span class="error">Confirmado, pero hubo un error cerrando el pago.</span>';
              showDebug({ ok: false, status: r.status, step: "affirm-authorize", response: data });
              return;
            }

            statusEl.innerHTML = '<span class="success">Confirmación completada.</span>';

            try {
              sessionStorage.removeItem("affirm_order_id");
              sessionStorage.removeItem("affirm_order_amount_cents");
              sessionStorage.removeItem("affirm_checkout_token");
              sessionStorage.removeItem("affirm_captured_order_id");
              localStorage.removeItem("affirm_order_id");
              localStorage.removeItem("affirm_order_amount_cents");
              localStorage.removeItem("affirm_checkout_token");
              localStorage.removeItem("affirm_captured_order_id");
            } catch {}
          } catch (e) {
            statusEl.innerHTML = '<span class="error">Confirmado, pero hubo un error de red confirmando el pago.</span>';
            showDebug({ ok: false, step: "network", message: String(e && e.message ? e.message : e) });
          }
        })();
      </script>
    </div>
  </body>
</html>
