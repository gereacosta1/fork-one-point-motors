<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Pago con Affirm ‚Äì Confirmado</title>
  <style>
    body{background:#0b0b0b;color:#fff;font-family:system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji";margin:0;padding:40px}
    .card{max-width:720px;margin:0 auto;background:#111;border:1px solid #2a2a2a;border-radius:16px;padding:24px}
    .ok{display:inline-block;padding:6px 10px;border-radius:999px;background:#16a34a;color:#fff;font-weight:700;font-size:12px;letter-spacing:.02em}
    pre{background:#0f0f0f;border:1px solid #272727;border-radius:12px;padding:12px;overflow:auto}
    a{color:#38bdf8}
  </style>
</head>
<body>
  <div class="card">
    <div class="ok">Autorizado</div>
    <h1>Gracias, tu solicitud en Affirm fue enviada.</h1>
    <p>Pod√©s cerrar esta ventana y volver a la tienda.</p>
    <p><a href="/">Volver a ONE POINT MOTORS</a></p>

    <!-- üîé DEBUG checkout_token -->
    <div id="tokenBox"></div>
    <script>
  (async () => {
    const q = new URLSearchParams(location.search);
    const tok = q.get('checkout_token');

    const order_id = sessionStorage.getItem('affirm_order_id');
    const amount_cents = Number(sessionStorage.getItem('affirm_amount_cents') || 0);

    const box = document.getElementById("tokenBox");

    if (!tok) {
      box.innerHTML = `<p style="color:#f87171">Error: no lleg√≥ checkout_token.</p>`;
      return;
    }

    // UI debug m√≠nima
    box.innerHTML = `
      <h2>checkout_token capturado:</h2>
      <pre>${tok}</pre>
      <p>Capturando el pago...</p>
    `;

    if (!order_id || !Number.isInteger(amount_cents) || amount_cents <= 0) {
      box.innerHTML += `
        <p style="color:#f87171">
          Falta order_id o amount_cents. No puedo capturar autom√°ticamente.<br/>
          order_id: ${order_id || '(vac√≠o)'}<br/>
          amount_cents: ${amount_cents || '(vac√≠o)'}
        </p>`;
      console.error("Missing order_id / amount_cents", { order_id, amount_cents });
      return;
    }

    try {
      const r = await fetch('/.netlify/functions/affirm-authorize', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          checkout_token: tok,
          order_id,
          amount_cents,
          // opcional: shipping_carrier, shipping_confirmation
        })
      });

      const data = await r.json().catch(() => ({}));

      if (!r.ok || !data.ok) {
        box.innerHTML += `<p style="color:#f87171">Error capturando: ${r.status}</p><pre>${JSON.stringify(data, null, 2)}</pre>`;
        console.error("Capture error", r.status, data);
        return;
      }

      box.innerHTML += `<p style="color:#34d399">Listo: pago capturado.</p><pre>${JSON.stringify(data, null, 2)}</pre>`;
      console.log("Captured:", data);

      // Limpieza para que no quede basura
      sessionStorage.removeItem('affirm_order_id');
      sessionStorage.removeItem('affirm_amount_cents');

    } catch (e) {
      box.innerHTML += `<p style="color:#f87171">Error de red capturando.</p>`;
      console.error(e);
    }
  })();
</script>

  </div>
</body>
</html>
