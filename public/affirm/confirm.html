<!doctype html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Pago con Affirm – Confirmado</title>
    <style>
      body { background:#0b0b0b; color:#fff; font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,"Helvetica Neue",Arial,"Noto Sans"; margin:0; padding:40px; }
      .card { max-width:720px; margin:0 auto; background:#111; border:1px solid #2a2a2a; border-radius:16px; padding:24px; }
      .ok { display:inline-block; padding:6px 10px; border-radius:999px; background:#16a34a; color:#fff; font-weight:700; font-size:12px; letter-spacing:.02em; }
      a { color:#38bdf8; }
      .muted { color:#cfcfcf; }
      .hint { margin-top:14px; font-size:13px; color:#9aa0a6; }
      pre { background:#0f0f0f; border:1px solid #272727; border-radius:12px; padding:12px; overflow:auto; color:#e5e7eb; }
      .error { color:#f87171; }
      .success { color:#34d399; }
      .btn {
        display:inline-block; margin-top:12px;
        padding:10px 14px; border-radius:12px;
        background:#1b1b1b; border:1px solid #2a2a2a;
        color:#fff; text-decoration:none;
      }
    </style>
  </head>
  <body>
    <div class="card">
      <div class="ok">Confirmado</div>
      <h1>Gracias, tu solicitud en Affirm fue enviada.</h1>
      <p class="muted">
        Ya podés cerrar esta ventana y volver a la tienda. Si no ves el pedido reflejado, avisale al vendedor.
      </p>
      <p><a href="/">Volver a ONE POINT MOTORS</a></p>

      <div id="status" class="hint">Procesando confirmación…</div>
      <pre id="debug" style="display:none"></pre>
      <a id="retryBtn" class="btn" href="#" style="display:none">Reintentar</a>

      <script>
        (async () => {
          const statusEl = document.getElementById("status");
          const debugEl = document.getElementById("debug");
          const retryBtn = document.getElementById("retryBtn");

          const showDebug = (obj) => {
            debugEl.style.display = "block";
            debugEl.textContent = JSON.stringify(obj, null, 2);
          };

          const q = new URLSearchParams(location.search);
          const checkout_token = q.get("checkout_token") || sessionStorage.getItem("affirm_checkout_token");

          const order_id = sessionStorage.getItem("affirm_order_id");
          const amount_cents_raw = sessionStorage.getItem("affirm_order_amount_cents");
          const amount_cents = Number(amount_cents_raw);

          const captured_order_id = sessionStorage.getItem("affirm_captured_order_id");

          // Sin token: la página igual sirve (pero no puede cerrar el pago)
          if (!checkout_token) {
            statusEl.textContent = "Confirmación recibida.";
            return;
          }

          // Evita doble capture si ya capturaste en onSuccess
          if (captured_order_id && order_id && captured_order_id === order_id) {
            statusEl.innerHTML = '<span class="success">Confirmación completada.</span>';
            try {
              sessionStorage.removeItem("affirm_order_id");
              sessionStorage.removeItem("affirm_order_amount_cents");
              sessionStorage.removeItem("affirm_checkout_token");
              sessionStorage.removeItem("affirm_captured_order_id");
            } catch {}
            return;
          }

          // Si faltan datos locales, no se puede capturar
          if (!order_id || !Number.isFinite(amount_cents) || amount_cents <= 0) {
            statusEl.innerHTML = '<span class="error">Confirmado, pero faltó información local para cerrar el pago.</span>';
            showDebug({
              ok: false,
              step: "confirm.html",
              error: "missing_order_id_or_amount",
              has_checkout_token: Boolean(checkout_token),
              has_order_id: Boolean(order_id),
              amount_cents_raw
            });
            return;
          }

          const run = async () => {
            statusEl.textContent = "Cerrando el pago con Affirm…";
            retryBtn.style.display = "none";
            debugEl.style.display = "none";

            try {
              const r = await fetch("/.netlify/functions/affirm-authorize", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ checkout_token, order_id, amount_cents, capture: true }),
              });

              const data = await r.json().catch(() => ({}));

              if (!r.ok || !data.ok) {
                statusEl.innerHTML = '<span class="error">Confirmado, pero hubo un error cerrando el pago.</span>';
                showDebug({ ok: false, status: r.status, step: "affirm-authorize", response: data });
                retryBtn.style.display = "inline-block";
                return;
              }

              statusEl.innerHTML = '<span class="success">Confirmación completada.</span>';

              try {
                sessionStorage.removeItem("affirm_order_id");
                sessionStorage.removeItem("affirm_order_amount_cents");
                sessionStorage.removeItem("affirm_checkout_token");
                sessionStorage.removeItem("affirm_captured_order_id");
              } catch {}
            } catch (e) {
              statusEl.innerHTML = '<span class="error">Confirmado, pero hubo un error de red confirmando el pago.</span>';
              showDebug({ ok: false, step: "network", message: String(e && e.message ? e.message : e) });
              retryBtn.style.display = "inline-block";
            }
          };

          retryBtn.addEventListener("click", (ev) => {
            ev.preventDefault();
            run();
          });

          await run();
        })();
      </script>
    </div>
  </body>
</html>
